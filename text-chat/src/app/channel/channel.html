<br>
<div class="mt-3" *ngIf="role == 'User'; else admin">
    <strong>Channels:</strong>

    <ng-container *ngIf="filteredChannels.length; else noChannels">
        <ul class="list-group mt-2">
            <li class="list-group-item" *ngFor="let channel of paginatedChannels">
                <div class="list-item-customer" (click)="enterChannel(channel.channel)">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {{ channel.channel.name }}
                        </div>
                        <div>
                            <button class="btn btn-sm btn-icon" 
                                    (click)="openChannelDetailsModal(channel); $event.stopPropagation()"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#channelDetailsModal">
                                <i class="bi bi-three-dots"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
        <nav *ngIf="getTotalChannelsPages() > 1" class="d-flex justify-content-end mt-2">
            <ul class="pagination pagination-sm">
                <li class="page-item" [class.disabled]="channelsCurrentPage === 1">
                    <button class="page-link" (click)="changeChannelsPage(-1)">Previous</button>
                </li>
                <li class="page-item" [class.disabled]="channelsCurrentPage >= getTotalChannelsPages()">
                    <button class="page-link" (click)="changeChannelsPage(1)">Next</button>
                </li>
            </ul>
        </nav>

    </ng-container>


    <ng-template #noChannels>
        <p><em>None</em></p>
        <br>
        <div class="mt-2">
            <button class="btn btn-outline-danger rounded-pill px-3" (click)="leaveGroup()">
                Leave Group
            </button>
        </div>
    </ng-template>
</div>

<ng-template #admin>
    <div class="d-flex">
        <div class="me-3" style="width: 200px; height: 100vh; overflow-y: auto;">
            <strong>Users:</strong>
            <br>
            <ul class="list-group">
                <li class="list-group-item py-2 px-2" *ngFor="let user of filteredUsers" style="font-size: 0.85rem;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-2">
                            <ng-container
                                *ngIf="user.user.profilePicture && user.user.profilePicture != ''; else defaultPic">
                                <img [src]="user.user.profilePicture" class="rounded-circle"
                                    style="width: 25px; height: 25px; object-fit: cover; aspect-ratio: 1;"
                                    alt="Profile Picture" />
                            </ng-container>
                            <ng-template #defaultPic>
                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                                    style="width: 25px; height: 25px; font-size: 0.75rem; line-height: 1; aspect-ratio: 1;">
                                    {{ user.user.username[0] | uppercase }}
                                </div>
                            </ng-template>
                        </div>

                        <button class="btn btn-sm btn-outline-primary rounded-pill me-1 px-2 py-0"
                            style="font-size: 0.75rem;" data-bs-toggle="modal" data-bs-target="#modifyUserModal"
                            (click)="updateUser(user.user)"
                            *ngIf="user.user.role == 'User' || (user.user.role == 'GroupAdmin' && role == 'SuperAdmin')">
                            Modify
                        </button>
                    </div>
                    <div class="mt-1 text-truncate" style="max-width: 100%;">
                        <small class="text-muted">User: {{ user.user.username }}</small>
                        <span class="badge rounded-pill bg-info text-dark ms-2">
                            {{ user.user.role }}
                        </span>
                    </div>
                </li>
            </ul>
            <br>
            <div class="mt-2" *ngIf="role == 'SuperAdmin' || role == 'GroupAdmin'">
                <button class="btn btn-outline-success rounded-pill px-3" data-bs-toggle="modal"
                    data-bs-target="#addNewUserModal">
                    <i class="bi bi-person-plus-fill me-2"></i> Add New User
                </button>
            </div>
        </div>

        <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Channels:</strong>
                <button *ngIf="role == 'SuperAdmin' || role == 'GroupAdmin'" 
                        class="btn btn-sm btn-success rounded-pill" 
                        data-bs-toggle="modal" 
                        data-bs-target="#createChannelModal">
                <i class="bi bi-plus-circle me-1"></i>
                Create New Channel
                </button>
            </div>

            <ng-container *ngIf="filteredChannels.length; else noChannels">
                <ul class="list-group mt-2">
                    <li class="list-group-item" *ngFor="let channel of paginatedChannels">
                        <div class="list-item-customer" (click)="enterChannel(channel.channel)">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    {{ channel.channel.name }}
                                </div>
                                <div *ngIf="role === 'SuperAdmin' || role === 'GroupAdmin'">
                                    <button class="btn btn-sm btn-icon" 
                                            (click)="openChannelDetailsModal(channel); $event.stopPropagation()"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#channelDetailsModal">
                                        <i class="bi bi-three-dots"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
                <nav *ngIf="getTotalChannelsPages() > 1" class="d-flex justify-content-end mt-2">
                    <ul class="pagination pagination-sm">
                        <li class="page-item" [class.disabled]="channelsCurrentPage === 1">
                            <button class="page-link" (click)="changeChannelsPage(-1)">Previous</button>
                        </li>
                        <li class="page-item" [class.disabled]="channelsCurrentPage >= getTotalChannelsPages()">
                            <button class="page-link" (click)="changeChannelsPage(1)">Next</button>
                        </li>
                    </ul>
                </nav>

            </ng-container>


            <ng-template #noChannels>
                <p><em>None</em></p>
                <br>
                <div class="mt-2" *ngIf="role == 'SuperAdmin' || role == 'GroupAdmin'">
                    <button class="btn btn-outline-success rounded-pill px-3" data-bs-toggle="modal"
                        data-bs-target="#createChannelModal">
                        Create New Channel
                    </button>
                </div>
            </ng-template>

        </div>
    </div>
</ng-template>


<div class="modal fade" id="createChannelModal" tabindex="-1" aria-labelledby="createChannelModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="createChannelModalLabe">Create New Channel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label for="newChannelNameInput" class="form-label">New Channel Name</label>
                <input id="newChannelNameInput" type="text" class="form-control" [(ngModel)]="newChannelName" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-success rounded-pill"
                    (click)="createChannel()">Create</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modifyUserModal" tabindex="-1" aria-labelledby="modifyUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modifyUserModalLabel">Modify User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">

                <!-- Report User -->
                <div class="modal-content p-2" *ngIf="userUpdate && userUpdate.role == 'User'">
                    <button type="button" class="btn btn-outline-primary rounded-pill" (click)="reportUser()">
                        Report
                    </button>
                </div>

                <!-- Remove From Group -->
                <div class="modal-content p-2">
                    <button type="button" class="btn btn-outline-primary rounded-pill" (click)="removeUserFromGroup()">
                        Remove User From Group
                    </button>
                </div>

                <!-- Ban From Channel -->
                <div class="modal-content p-2" *ngIf="userUpdate && userUpdate.role == 'User'">
                    <label class="form-label">Ban User From Channel</label>
                    <div class="d-flex flex-wrap gap-1">
                        <button *ngFor="let channel of channels" class="btn btn-sm btn-outline-danger rounded-pill"
                            (click)="banUserFromChannel(channel)">
                            {{ channel.name }}
                        </button>
                    </div>
                </div>

                <!-- Add To Channel -->
                <div class="modal-content p-2" *ngIf="userUpdate && userUpdate.role == 'User'">
                    <label class="form-label">Add User To Channel</label>
                    <div class="d-flex flex-wrap gap-1">
                        <button *ngFor="let channel of channels" class="btn btn-sm btn-outline-success rounded-pill"
                            (click)="addUserToChannel(channel)">
                            {{ channel.name }}
                        </button>
                    </div>
                </div>

                <!-- Promote User -->
                <div class="modal-content p-2" *ngIf="role === 'SuperAdmin'">
                    <label class="form-label">Promote User</label>
                    <select class="form-select mb-2" [(ngModel)]="selectedRole">
                        <option value="" disabled selected>Select Role</option>
                        <option value="GroupAdmin">GroupAdmin</option>
                        <option value="SuperAdmin">SuperAdmin</option>
                    </select>
                    <button type="button" class="btn btn-outline-success rounded-pill" [disabled]="!selectedRole"
                        (click)="promoteUser(selectedRole)">
                        Promote
                    </button>
                </div>

                <!-- Delete User -->
                <div class="modal-content p-2" *ngIf="role === 'SuperAdmin'">
                    <label class="form-label">Delete User</label>
                    <button type="button" class="btn btn-outline-danger rounded-pill" (click)="deleteUser()">
                        Delete
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addNewUserModal" tabindex="-1" aria-labelledby="addNewUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addNewUserModalLabel">Add New User to Group</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label for="userSelect" class="form-label fw-semibold">All Users</label>
                <div class="custom-select-wrapper">
                    <select id="userSelect"
                        class="form-select custom-select-scroll shadow-sm rounded-3 border border-primary-subtle"
                        size="6" [(ngModel)]="newAddUser">
                        <option *ngFor="let userWrapper of filteredAllUsers" [ngValue]="userWrapper.user">
                            {{ userWrapper.user.username }}
                        </option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-success rounded-pill" (click)="addNewUser()">Add</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="channelDetailsModal" tabindex="-1" aria-labelledby="channelDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" *ngIf="selectedChannel">
      <div class="modal-header">
        <h5 class="modal-title" id="channelDetailsModalLabel">
          Channel Details: <strong>{{ selectedChannel.channel.name }}</strong>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between align-items-center">
            Total Messages:
            <span class="badge bg-secondary rounded-pill">{{ selectedChannel.channel.messages.length }}</span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            Users with Access:
            <span class="badge bg-secondary rounded-pill">{{ selectedChannel.channel.allowedUsers.length }}</span>
          </li>
        </ul>
      </div>
      <div class="modal-footer" *ngIf="role === 'SuperAdmin' || role === 'GroupAdmin'">
        <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger rounded-pill" (click)="removeChannel(selectedChannel.channel.id)" data-bs-dismiss="modal">
          <i class="bi bi-trash me-1"></i>Delete Channel
        </button>
      </div>
    </div>
  </div>
</div>